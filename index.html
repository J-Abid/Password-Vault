<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureVault - Password Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
        .card-glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .password-mask { font-family: 'Courier New', monospace; letter-spacing: 2px; }
        .strength-weak { background: #ef4444; width: 25%; }
        .strength-fair { background: #f59e0b; width: 50%; }
        .strength-good { background: #3b82f6; width: 75%; }
        .strength-strong { background: #10b981; width: 100%; }
        .category-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; }
        .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pulse-glow { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Lock Screen -->
    <div id="lockScreen" class="fixed inset-0 flex items-center justify-center z-50 gradient-bg">
        <div class="card-glass rounded-2xl p-8 w-full max-w-md mx-4 slide-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 pulse-glow">
                    <i class="fas fa-shield-alt text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold">SecureVault</h1>
                <p class="text-gray-400 mt-2">Your passwords, safely stored</p>
            </div>
            <div id="lockForm">
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Master Password</label>
                    <div class="relative">
                        <input type="password" id="masterPassword" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Enter master password">
                        <button onclick="togglePasswordVisibility('masterPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button onclick="unlock()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <i class="fas fa-unlock mr-2"></i>Unlock Vault
                </button>
                <p id="lockError" class="text-red-400 text-sm mt-3 text-center hidden">Incorrect password</p>
                <div class="mt-6 text-center">
                    <button onclick="showSetupMode()" class="text-blue-400 hover:text-blue-300 text-sm">First time? Create master password</button>
                </div>
            </div>
            <div id="setupForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Create Master Password</label>
                    <input type="password" id="newMasterPassword" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Create a strong password">
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-2">Confirm Password</label>
                    <input type="password" id="confirmMasterPassword" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition" placeholder="Confirm password">
                </div>
                <button onclick="setupVault()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <i class="fas fa-key mr-2"></i>Create Vault
                </button>
                <p id="setupError" class="text-red-400 text-sm mt-3 text-center hidden"></p>
                <div class="mt-6 text-center">
                    <button onclick="showLoginMode()" class="text-blue-400 hover:text-blue-300 text-sm">Already have a vault? Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-gray-900/50 border-b border-gray-800 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h1 class="text-xl font-bold">SecureVault</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openGeneratorModal()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span class="hidden sm:inline">Generate</span>
                    </button>
                    <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        <span class="hidden sm:inline">Add New</span>
                    </button>
                    <div class="relative">
                        <button onclick="toggleMenu()" class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-700 transition">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl border border-gray-700 py-2">
                            <button onclick="exportPasswords('json')" class="w-full px-4 py-2 text-left hover:bg-gray-700 flex items-center gap-2">
                                <i class="fas fa-file-code"></i> Export JSON
                            </button>
                            <button onclick="exportPasswords('csv')" class="w-full px-4 py-2 text-left hover:bg-gray-700 flex items-center gap-2">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <hr class="border-gray-700 my-2">
                            <button onclick="lockVault()" class="w-full px-4 py-2 text-left hover:bg-gray-700 flex items-center gap-2 text-red-400">
                                <i class="fas fa-lock"></i> Lock Vault
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Search and Filter Bar -->
            <div class="card-glass rounded-xl p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchInput" onkeyup="filterPasswords()" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="Search passwords...">
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="filterByCategory('all')" class="category-filter active bg-blue-600 px-4 py-2 rounded-lg text-sm transition" data-category="all">All</button>
                        <button onclick="filterByCategory('social')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="social">
                            <i class="fas fa-users mr-1"></i>Social
                        </button>
                        <button onclick="filterByCategory('finance')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="finance">
                            <i class="fas fa-university mr-1"></i>Finance
                        </button>
                        <button onclick="filterByCategory('work')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="work">
                            <i class="fas fa-briefcase mr-1"></i>Work
                        </button>
                        <button onclick="filterByCategory('shopping')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="shopping">
                            <i class="fas fa-shopping-cart mr-1"></i>Shopping
                        </button>
                        <button onclick="filterByCategory('entertainment')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="entertainment">
                            <i class="fas fa-gamepad mr-1"></i>Entertainment
                        </button>
                        <button onclick="filterByCategory('other')" class="category-filter bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition" data-category="other">
                            <i class="fas fa-folder mr-1"></i>Other
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-key text-blue-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="totalCount">0</p>
                            <p class="text-gray-400 text-sm">Total</p>
                        </div>
                    </div>
                </div>
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-shield-alt text-green-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="strongCount">0</p>
                            <p class="text-gray-400 text-sm">Strong</p>
                        </div>
                    </div>
                </div>
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-yellow-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="weakCount">0</p>
                            <p class="text-gray-400 text-sm">Weak</p>
                        </div>
                    </div>
                </div>
                <div class="card-glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-folder text-purple-400"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold" id="categoryCount">0</p>
                            <p class="text-gray-400 text-sm">Categories</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password List -->
            <div id="passwordList" class="grid gap-4">
                <!-- Passwords will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-16">
                <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-lock text-4xl text-gray-600"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">No passwords yet</h3>
                <p class="text-gray-400 mb-6">Start by adding your first password</p>
                <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition">
                    <i class="fas fa-plus mr-2"></i>Add Password
                </button>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="card-glass rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto slide-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="modalTitle" class="text-xl font-bold">Add New Password</h2>
                    <button onclick="closeAddModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="passwordForm" onsubmit="savePassword(event)">
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Title *</label>
                            <input type="text" id="entryTitle" required class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="e.g., Gmail Account">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Username / Email</label>
                            <input type="text" id="entryUsername" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="username@example.com">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Password *</label>
                            <div class="relative">
                                <input type="password" id="entryPassword" required class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 pr-20 focus:outline-none focus:border-blue-500 transition" placeholder="Enter password">
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                    <button type="button" onclick="togglePasswordVisibility('entryPassword')" class="p-1 text-gray-400 hover:text-white">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" onclick="generateForField()" class="p-1 text-purple-400 hover:text-purple-300">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                                    <div id="passwordStrengthBar" class="h-full transition-all duration-300"></div>
                                </div>
                                <p id="passwordStrengthText" class="text-xs mt-1 text-gray-400"></p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Website URL</label>
                            <input type="url" id="entryUrl" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition" placeholder="https://example.com">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Category</label>
                            <select id="entryCategory" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition">
                                <option value="other">Other</option>
                                <option value="social">Social</option>
                                <option value="finance">Finance</option>
                                <option value="work">Work</option>
                                <option value="shopping">Shopping</option>
                                <option value="entertainment">Entertainment</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Notes</label>
                            <textarea id="entryNotes" rows="3" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 transition resize-none" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeAddModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition">Cancel</button>
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Password Generator Modal -->
    <div id="generatorModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="card-glass rounded-2xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold"><i class="fas fa-magic mr-2 text-purple-400"></i>Password Generator</h2>
                    <button onclick="closeGeneratorModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <code id="generatedPassword" class="text-lg font-mono text-green-400 break-all">Click Generate</code>
                        <div class="flex gap-2 ml-4">
                            <button onclick="copyGeneratedPassword()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="generatePassword()" class="p-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition" title="Regenerate">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm text-gray-400">Length: <span id="lengthValue">16</span></label>
                        </div>
                        <input type="range" id="passwordLength" min="8" max="64" value="16" oninput="updateLength()" class="w-full accent-purple-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeUpper" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Uppercase (A-Z)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeLower" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Lowercase (a-z)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeNumbers" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Numbers (0-9)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeSymbols" checked class="accent-purple-500 w-4 h-4">
                            <span class="text-sm">Symbols (!@#$)</span>
                        </label>
                    </div>
                </div>
                <button onclick="generatePassword()" class="w-full mt-6 bg-gradient-to-r from-purple-500 to-pink-600 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    <i class="fas fa-magic mr-2"></i>Generate Password
                </button>
            </div>
        </div>
    </div>

    <!-- View Password Modal -->
    <div id="viewModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="card-glass rounded-2xl w-full max-w-lg slide-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="viewTitle" class="text-xl font-bold">Password Details</h2>
                    <button onclick="closeViewModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="viewContent" class="space-y-4">
                    <!-- Content rendered dynamically -->
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeViewModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition">Close</button>
                    <button id="viewEditBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg transition">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="flex items-center gap-3">
            <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
            <span id="toastMessage">Password copied!</span>
        </div>
    </div>

    <script>
        // State Management
        let passwords = [];
        let currentFilter = 'all';
        let masterKey = null;

        // Category Colors
        const categoryColors = {
            social: 'bg-blue-500',
            finance: 'bg-green-500',
            work: 'bg-yellow-500',
            shopping: 'bg-pink-500',
            entertainment: 'bg-purple-500',
            other: 'bg-gray-500'
        };

        const categoryIcons = {
            social: 'fa-users',
            finance: 'fa-university',
            work: 'fa-briefcase',
            shopping: 'fa-shopping-cart',
            entertainment: 'fa-gamepad',
            other: 'fa-folder'
        };

        // Simple encryption/decryption (for demo - use proper encryption in production)
        function encrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        }

        function decrypt(text, key) {
            try {
                const decoded = atob(text);
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            } catch {
                return null;
            }
        }

        // Hash function for master password
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Lock Screen Functions
        function showSetupMode() {
            document.getElementById('lockForm').classList.add('hidden');
            document.getElementById('setupForm').classList.remove('hidden');
        }

        function showLoginMode() {
            document.getElementById('setupForm').classList.add('hidden');
            document.getElementById('lockForm').classList.remove('hidden');
        }

        async function setupVault() {
            const password = document.getElementById('newMasterPassword').value;
            const confirm = document.getElementById('confirmMasterPassword').value;
            const errorEl = document.getElementById('setupError');

            if (password.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            const hash = await hashPassword(password);
            localStorage.setItem('vaultMasterHash', hash);
            masterKey = password;
            localStorage.setItem('vaultPasswords', encrypt(JSON.stringify([]), masterKey));
            
            document.getElementById('lockScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadPasswords();
            showToast('Vault created successfully!', 'success');
        }

        async function unlock() {
            const password = document.getElementById('masterPassword').value;
            const storedHash = localStorage.getItem('vaultMasterHash');
            const errorEl = document.getElementById('lockError');

            if (!storedHash) {
                errorEl.textContent = 'No vault found. Please create one first.';
                errorEl.classList.remove('hidden');
                return;
            }

            const hash = await hashPassword(password);
            if (hash === storedHash) {
                masterKey = password;
                document.getElementById('lockScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadPasswords();
            } else {
                errorEl.classList.remove('hidden');
            }
        }

        function lockVault() {
            masterKey = null;
            passwords = [];
            document.getElementById('masterPassword').value = '';
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('lockScreen').classList.remove('hidden');
            document.getElementById('dropdownMenu').classList.add('hidden');
        }

        // Password Management
        function loadPasswords() {
            const encrypted = localStorage.getItem('vaultPasswords');
            if (encrypted) {
                const decrypted = decrypt(encrypted, masterKey);
                if (decrypted) {
                    passwords = JSON.parse(decrypted);
                }
            }
            renderPasswords();
            updateStats();
        }

        function savePasswords() {
            const encrypted = encrypt(JSON.stringify(passwords), masterKey);
            localStorage.setItem('vaultPasswords', encrypted);
        }

        function renderPasswords() {
            const container = document.getElementById('passwordList');
            const emptyState = document.getElementById('emptyState');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = passwords.filter(p => {
                const matchesSearch = p.title.toLowerCase().includes(searchTerm) || 
                                     p.username.toLowerCase().includes(searchTerm) ||
                                     p.url.toLowerCase().includes(searchTerm);
                const matchesCategory = currentFilter === 'all' || p.category === currentFilter;
                return matchesSearch && matchesCategory;
            });

            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = filtered.map(p => `
                <div class="card-glass rounded-xl p-4 hover:border-blue-500/50 transition cursor-pointer" onclick="viewPassword('${p.id}')">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 ${categoryColors[p.category]} rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas ${categoryIcons[p.category]} text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold truncate">${escapeHtml(p.title)}</h3>
                                <span class="category-badge ${categoryColors[p.category]} text-white">${p.category}</span>
                            </div>
                            <p class="text-gray-400 text-sm truncate">${escapeHtml(p.username) || 'No username'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); copyToClipboard('${p.id}', 'username')" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" title="Copy Username">
                                <i class="fas fa-user text-sm"></i>
                            </button>
                            <button onclick="event.stopPropagation(); copyToClipboard('${p.id}', 'password')" class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition" title="Copy Password">
                                <i class="fas fa-key text-sm"></i>
                            </button>
                            ${p.url ? `<a href="${escapeHtml(p.url)}" target="_blank" onclick="event.stopPropagation()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" title="Visit Site"><i class="fas fa-external-link-alt text-sm"></i></a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = passwords.length;
            
            let strongCount = 0;
            let weakCount = 0;
            passwords.forEach(p => {
                const strength = getPasswordStrength(p.password);
                if (strength.level === 'strong') strongCount++;
                else if (strength.level === 'weak') weakCount++;
            });

            document.getElementById('strongCount').textContent = strongCount;
            document.getElementById('weakCount').textContent = weakCount;

            const categories = new Set(passwords.map(p => p.category));
            document.getElementById('categoryCount').textContent = categories.size;
        }

        // Modal Functions
        function openAddModal(editId = null) {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('passwordForm');
            
            form.reset();
            document.getElementById('editId').value = '';
            document.getElementById('passwordStrengthBar').className = 'h-full transition-all duration-300';
            document.getElementById('passwordStrengthText').textContent = '';

            if (editId) {
                const entry = passwords.find(p => p.id === editId);
                if (entry) {
                    title.textContent = 'Edit Password';
                    document.getElementById('editId').value = entry.id;
                    document.getElementById('entryTitle').value = entry.title;
                    document.getElementById('entryUsername').value = entry.username;
                    document.getElementById('entryPassword').value = entry.password;
                    document.getElementById('entryUrl').value = entry.url;
                    document.getElementById('entryCategory').value = entry.category;
                    document.getElementById('entryNotes').value = entry.notes;
                    updatePasswordStrengthUI(entry.password);
                }
            } else {
                title.textContent = 'Add New Password';
            }

            modal.classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        function savePassword(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const entry = {
                id: editId || Date.now().toString(),
                title: document.getElementById('entryTitle').value,
                username: document.getElementById('entryUsername').value,
                password: document.getElementById('entryPassword').value,
                url: document.getElementById('entryUrl').value,
                category: document.getElementById('entryCategory').value,
                notes: document.getElementById('entryNotes').value,
                createdAt: editId ? passwords.find(p => p.id === editId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (editId) {
                const index = passwords.findIndex(p => p.id === editId);
                passwords[index] = entry;
                showToast('Password updated successfully!', 'success');
            } else {
                passwords.push(entry);
                showToast('Password saved successfully!', 'success');
            }

            savePasswords();
            renderPasswords();
            updateStats();
            closeAddModal();
        }

        function viewPassword(id) {
            const entry = passwords.find(p => p.id === id);
            if (!entry) return;

            const modal = document.getElementById('viewModal');
            document.getElementById('viewTitle').textContent = entry.title;
            
            const strength = getPasswordStrength(entry.password);
            
            document.getElementById('viewContent').innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg">
                        <div class="w-10 h-10 ${categoryColors[entry.category]} rounded-lg flex items-center justify-center">
                            <i class="fas ${categoryIcons[entry.category]}"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Category</p>
                            <p class="capitalize">${entry.category}</p>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-400">Username</p>
                                <p>${escapeHtml(entry.username) || '-'}</p>
                            </div>
                            <button onclick="copyToClipboard('${entry.id}', 'username')" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm text-gray-400">Password</p>
                                <p id="viewPasswordText" class="password-mask">••••••••••••</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleViewPassword('${entry.id}')" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                    <i class="fas fa-eye" id="viewPasswordIcon"></i>
                                </button>
                                <button onclick="copyToClipboard('${entry.id}', 'password')" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full ${strength.class}"></div>
                            </div>
                            <p class="text-xs mt-1 text-gray-400">Strength: ${strength.text}</p>
                        </div>
                    </div>

                    ${entry.url ? `
                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-400">Website</p>
                                <p class="truncate">${escapeHtml(entry.url)}</p>
                            </div>
                            <a href="${escapeHtml(entry.url)}" target="_blank" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                    ` : ''}

                    ${entry.notes ? `
                    <div class="p-3 bg-gray-800/50 rounded-lg">
                        <p class="text-sm text-gray-400">Notes</p>
                        <p class="whitespace-pre-wrap">${escapeHtml(entry.notes)}</p>
                    </div>
                    ` : ''}

                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Created: ${new Date(entry.createdAt).toLocaleDateString()}</span>
                        <span>Updated: ${new Date(entry.updatedAt).toLocaleDateString()}</span>
                    </div>
                </div>
            `;

            document.getElementById('viewEditBtn').onclick = () => {
                closeViewModal();
                openAddModal(id);
            };

            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg transition';
            deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete';
            deleteBtn.onclick = () => deletePassword(id);
            
            const btnContainer = modal.querySelector('.flex.gap-3.mt-6');
            if (btnContainer.children.length === 2) {
                btnContainer.appendChild(deleteBtn);
            }

            modal.classList.remove('hidden');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.add('hidden');
        }

        let viewPasswordVisible = false;
        function toggleViewPassword(id) {
            const entry = passwords.find(p => p.id === id);
            const textEl = document.getElementById('viewPasswordText');
            const iconEl = document.getElementById('viewPasswordIcon');
            
            viewPasswordVisible = !viewPasswordVisible;
            textEl.textContent = viewPasswordVisible ? entry.password : '••••••••••••';
            iconEl.className = viewPasswordVisible ? 'fas fa-eye-slash' : 'fas fa-eye';
        }

        function deletePassword(id) {
            if (confirm('Are you sure you want to delete this password?')) {
                passwords = passwords.filter(p => p.id !== id);
                savePasswords();
                renderPasswords();
                updateStats();
                closeViewModal();
                showToast('Password deleted', 'success');
            }
        }

        // Password Generator
        function openGeneratorModal() {
            document.getElementById('generatorModal').classList.remove('hidden');
            generatePassword();
        }

        function closeGeneratorModal() {
            document.getElementById('generatorModal').classList.add('hidden');
        }

        function updateLength() {
            document.getElementById('lengthValue').textContent = document.getElementById('passwordLength').value;
        }

        function generatePassword() {
            const length = parseInt(document.getElementById('passwordLength').value);
            const useUpper = document.getElementById('includeUpper').checked;
            const useLower = document.getElementById('includeLower').checked;
            const useNumbers = document.getElementById('includeNumbers').checked;
            const useSymbols = document.getElementById('includeSymbols').checked;

            let chars = '';
            if (useUpper) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (useLower) chars += 'abcdefghijklmnopqrstuvwxyz';
            if (useNumbers) chars += '0123456789';
            if (useSymbols) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';

            if (chars === '') {
                document.getElementById('generatedPassword').textContent = 'Select at least one option';
                return;
            }

            let password = '';
            const array = new Uint32Array(length);
            crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                password += chars[array[i] % chars.length];
            }

            document.getElementById('generatedPassword').textContent = password;
        }

        function copyGeneratedPassword() {
            const password = document.getElementById('generatedPassword').textContent;
            if (password && password !== 'Click Generate' && password !== 'Select at least one option') {
                navigator.clipboard.writeText(password);
                showToast('Password copied to clipboard!', 'success');
            }
        }

        function generateForField() {
            const length = 16;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            const array = new Uint32Array(length);
            crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                password += chars[array[i] % chars.length];
            }
            document.getElementById('entryPassword').value = password;
            updatePasswordStrengthUI(password);
        }

        // Password Strength
        function getPasswordStrength(password) {
            let score = 0;
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;

            if (score <= 2) return { level: 'weak', text: 'Weak', class: 'strength-weak' };
            if (score <= 3) return { level: 'fair', text: 'Fair', class: 'strength-fair' };
            if (score <= 4) return { level: 'good', text: 'Good', class: 'strength-good' };
            return { level: 'strong', text: 'Strong', class: 'strength-strong' };
        }

        function updatePasswordStrengthUI(password) {
            const strength = getPasswordStrength(password);
            const bar = document.getElementById('passwordStrengthBar');
            const text = document.getElementById('passwordStrengthText');
            
            bar.className = 'h-full transition-all duration-300 ' + strength.class;
            text.textContent = password ? `Strength: ${strength.text}` : '';
        }

        document.getElementById('entryPassword').addEventListener('input', (e) => {
            updatePasswordStrengthUI(e.target.value);
        });

        // Filter Functions
        function filterByCategory(category) {
            currentFilter = category;
            
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            
            document.querySelector(`[data-category="${category}"]`).classList.remove('bg-gray-700');
            document.querySelector(`[data-category="${category}"]`).classList.add('bg-blue-600');
            
            renderPasswords();
        }

        function filterPasswords() {
            renderPasswords();
        }

        // Copy to Clipboard
        function copyToClipboard(id, field) {
            const entry = passwords.find(p => p.id === id);
            if (entry) {
                const text = field === 'password' ? entry.password : entry.username;
                navigator.clipboard.writeText(text);
                showToast(`${field.charAt(0).toUpperCase() + field.slice(1)} copied!`, 'success');
            }
        }

        // Export Functions
        function exportPasswords(format) {
            let content, filename, type;
            
            if (format === 'json') {
                content = JSON.stringify(passwords, null, 2);
                filename = 'passwords_export.json';
                type = 'application/json';
            } else {
                const headers = ['Title', 'Username', 'Password', 'URL', 'Category', 'Notes'];
                const rows = passwords.map(p => [
                    p.title, p.username, p.password, p.url, p.category, p.notes
                ].map(v => `"${(v || '').replace(/"/g, '""')}"`).join(','));
                content = [headers.join(','), ...rows].join('\n');
                filename = 'passwords_export.csv';
                type = 'text/csv';
            }

            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('dropdownMenu').classList.add('hidden');
            showToast(`Exported as ${format.toUpperCase()}`, 'success');
        }

        // Utility Functions
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function toggleMenu() {
            document.getElementById('dropdownMenu').classList.toggle('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            msg.textContent = message;
            icon.className = type === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-exclamation-circle text-red-400';
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#dropdownMenu') && !e.target.closest('button')) {
                document.getElementById('dropdownMenu').classList.add('hidden');
            }
        });

        // Handle Enter key on lock screen
        document.getElementById('masterPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') unlock();
        });

        // Check if vault exists on load
        document.addEventListener('DOMContentLoaded', () => {
            const hasVault = localStorage.getItem('vaultMasterHash');
            if (!hasVault) {
                showSetupMode();
            }
        });
    </script>
</body>
</html>
